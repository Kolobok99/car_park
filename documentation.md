## Содержание:
1. [Титульный лист](#титульный_лист)
2. [Регистрация](#регистрация)
3. [Авторизация](#Авторизация)
4. [Личный кабинет](#личный_кабинет)
6. [Автомобили](#автомобили)
7. [Выбранное авто](#выбранное_авто)
8. [Водители](#водители)
9. [Выбранный водитель](#выбранный_водитель)
10. [Документы](#документы)
11. [Топливные карты](#топливные_карты)
12. [Заявки](#заявки)
13. [Выбранная заявка](#выбранная_заявка)
14. [История](#история)

12. [Celery](#celery)

13. [Telegram bot](#telegram_bot)

### Титульный лист

Идея и требования к проекту были позаимствованны из портфолио компании [< SMYT >](https://smyt.ru/). С  "ТЗ" проекта можно ознакомиться по [ссылке](https://smyt.ru/projects/sistema-lk-polzovatelej-avtoparka/) или ниже.


**Проект**: Система личных кабинетов администратора автопарка и водителей.

**Описание**:  Наш заказчик – компания, которая предоставляет услуги операционного лизинга автомобилей и услуги управления автопарками своих клиентов. Управление автопарком означает, что наш заказчик берет на себя все заботы по обслуживанию автомобилей своего клиента. Система ведет историю событий, связанных с каждым автомобилем. Клиенты (администраторы автопарка и обычные водители) в своих личных кабинетах по мере необходимости создают заявки на ремонт и обслуживание своих автомобилей. Наш заказчик принимает заявки в работу и проводит весь необходимый цикл работ по исполнению заявок. Клиенты отслеживают исполнение заявок.

Кроме того, администраторы автопарка на стороне клиента управляют водителями, топливными картами, страховыми полисами, водительскими удостоверениями, медицинскими справками и другими документами.

**Запуск проекта** (деплой проекта был протестирован на Ubuntu 20.04 LTS)
1. Перейти в корень проекта: *cd /car_park/*
2. Собрать докер-образы: *docker-compose -f prod_docker-compose.yml build*
3. Поднять проект *docker-compose -f prod_docker-compose.yml up*

**Запуск интеграционных тестов**
1. Перейти в корень проекта: *cd /car_park/*
2. Запустить тесты *pytest*


**Задачи**
Личный кабинет администратора автопарка должен выполнять следующие задачи:

-   ведение перечня автомобилей клиента;
-   создание и отслеживание заявок на ремонт автомобилей;
-   автоматическое информирование администратора о неисполненных в срок заявках на ремонт;
-   управление водителями;
-   ведение перечня топливных карт;
-   закрепление автомобилей и топливных карт за водителями;
-   ведение реестров различных документов (страховых полисов, водительских удостоверений, медицинских справок, доверенностей, актов и т. д.);
-   автоматическое информирование администратора об истекающих сроках действия документов;
-   ведение реестра осмотров автомобилей.
- фильтрация основных данных (автомобилей, водителей, документов, заявок, истории)
- ведение истории действий пользователей

Личный кабинет водителя должен выполнять следующие задачи:

-   отображение автомобилей, закрепленных за водителем;
-   создание и отслеживание заявок на ремонт автомобилей;
-   отображение документов (страховых полисов, водительских удостоверений, медицинских справок, доверенностей, актов и т. д.), относящихся к водителю или его автомобилю;
-   автоматическое информирование водителя об истекающих сроках действия документов.

**Технологии:**
- Python
- Django, DRF
- MySQL
- Pytest-Django + Selenium
- HTML, CSS, JS 
- Celery + Redis
- pyTelegramBotAPI
- Docker + docker-compose


### Регистрация


Для того, чтобы начать пользоваться приложением, новому водителю или механику необходимо пройти процесс регистрации. 

Для избежания неприятных моментов, связанных с безопасностью, новых администраторов автопарка (далее менеджеров) в системе регистрирует администратор приложения (он же root) в панели django-admin.

**P.S.** Для того, чтобы пройти процесс валидации почты, почта нового пользователя должна быть предварительно добавлена менеджером в таблицу "WhiteEmailList".

Для того, чтобы пройти процесс регистрации, гостю необходимо перейти на стр.

На этой странице гость видит форму регистрации и кнопку для перехода на стр. "авторизации".
При вводе валидных данных  и нажатии кнопки "Отправить",
![[Pasted image 20220707174947.png]]
в таблице MyUser создается запись с новым пользователем и параметром (is_active=False). Гость переадресовывается на стр. 
[активации аккаунта]( www.car-park.site/activation/), где ему предлагается ввести код активации, высланный на почту.
![[Pasted image 20220707175444.png]]

После отправки валидного кода, гость попадает на стр. [авторизации](http://127.0.0.1:8000/login/), а его аккаунт становится активным (is_active=True).

**P.S** При отправки невалидных данных, гостю возвращается форма с сообщениями об ошибках.
![[Pasted image 20220707175954.png]]


### Авторизация
После прохождения процесса регистрации, водитель (или механик) может авторизироваться в системе, введя корректные данные на стр. [авторизации](http://127.0.0.1:8000/)
![[Pasted image 20220707180619.png]]
При вводе невалидных данных, приложение возвращает сообщение об ошибке
![[Pasted image 20220707180907.png]].
**P.S.** В независимости от типа невалидных данных (неправильный пароль, неправильная почта, попытка войти в ЛК неактивированного аккаунта), система всегда возвращает одно и тоже сообщение.



### Личный кабинет
После успешной авторизации водитель переадресовывается на стр. [ЛК](http://127.0.0.1:8000/account/)

![[Pasted image 20220707184920.png]]

Здесь он может:
- изменять личные данные
![[Pasted image 20220707185435.png]]
при успешном изменении данных, появляется сообщение:
![[Pasted image 20220707185645.png]]
P.S. медиа файлы пользователей (аватарки и документы) хранятся в личной папке, которая создается во время регистрации. Название папки совпадает с email'ом. При изменении email'а, название папки также меняется
![[Pasted image 20220707185809.png]].

- работать с  закрепленными за ним автомобилями
![[Pasted image 20220707190149.png]]
При нажатии на *регистрационный номер*, водитель переадресовывается на стр. [выбранного авто](http://127.0.0.1:8000/cars/F128OS)
При нажатии на *название активной заявки*, водитель переадресовывается на стр. [выбранного авто](http://127.0.0.1:8000/applications/74)

- работать с созданными активными заявками
![[Pasted image 20220707190642.png]]
При нажатии на *регистрационный номер*, водитель переадресовывается на стр. [выбранного авто](http://127.0.0.1:8000/cars/F128OS)
При нажатии на *ID активной заявки*, водитель переадресовывается на стр. [выбранного авто](http://127.0.0.1:8000/applications/74)

- изменять баланс закрепленной за ним топливной карты
![[Pasted image 20220707190910.png]].
При успешном изменении баланса 
*(баланс должен быть >= 0 и <= лимиту)*
Появляется сообщение:
![[Pasted image 20220707191030.png]]

- добавлять и удалять персональные документы:
При нажатии на кнопку "добавить" (документ), появляется форма:
![[Pasted image 20220803130621.png]].
При отправки валидных данных (здесь невалидным может быть только *дата окончания*, она должна быть больше *даты выдачи*), появляется сообщение:
![[Pasted image 20220707191336.png]]
и новая запись в таблице.
![[Pasted image 20220707191407.png]]
При вводе невалидной даты, форма возвращается с сообщением об ошибке:
![[Pasted image 20220707191904.png]]
При нажатии на кнопку "удалить" (определенный документ), появляется окно подтверждения:
![[Pasted image 20220707191600.png]]
При нажатии кнопки "да" (удалить!), появляется сообщение:
![[Pasted image 20220707191627.png]]
и запись с ранее созданным документом пропадает:
![[Pasted image 20220707191740.png]]


**Также** стоит отметить, что водитель, хоть и видит меню сайта,
![[Pasted image 20220707192013.png]]
но при попытке перехода на любую из страниц, он получает сообщение:
![[Pasted image 20220707192049.png]]

**Также**, при попытке попасть на стр. чужой машины или заявки:
![[Pasted image 20220707192049.png]]

### Выбранное авто
После нажатия на регистрационный номер выбранного авто, владелец авто или менеджер попадает на соответствующую стр.  [страницу ](http://127.0.0.1:8000/cars/F128OS)
![[Pasted image 20220708130148.png]]
P.S. в отличии от водителя, менеджер имеет возможность менять информацию об авто
![[Pasted image 20220708130350.png]]

Здесь владелец авто и менеджер могут:
- Просматривать ранее созданные заявки и переходить на [стр. заявки](http://127.0.0.1:8000/applications/74 путем нажатия по ее ID.
- Добавлять  новые заявки. При нажатии на кнопку добавить (заявку), открывается форма добавления заявки.
![[Pasted image 20220708132416.png]]
Форма менеджера отличается наличием поля выбора механика.
![[Pasted image 20220729172325.png]]
После нажатия кнопки отправить, новая заявка появляется в таблице.
- таблица Документы, идентична таблице Документы на стр. ЛК.
![[Pasted image 20220708132607.png]]

### Выбранная заявка
После создания заявки (водителем), ей присваивается первичный статус: "Ожидает рассмотрения". 

Перейдя на [стр. заявки](), **владелец** заявки, может:
![[Pasted image 20220708133714.png]]
- ознакомиться со всей информацией;
- изменить заявку, нажав на кнопку "Изменить заявку". Появится форма, аналогичная форме на стр. выбранное авто; 
 ![[Pasted image 20220729172455.png]]
 - удалить заявку. При нажатии на кнопку "Удалить заявку", появится форма подтверждения.
 ![[Pasted image 20220708133756.png]]
 
 **Менеджер** при переходе на чужую заявку, может:
 ![[Pasted image 20220708133845.png]]
 - Одобрить заявку, нажав на кнопку "Подтвердить". После отправки формы, заявке присвоится статус "Ожидает  рассмотрения механика";
![[Pasted image 20220708134114.png]]
- Отклонить заявку, нажав на кнопку "Вернуть на доработку". После подтверждения, заявке присвоится статус "Отклонена".
![[Pasted image 20220708134223.png]]

### Автомобили
Перейдя на стр. [автомобили](http://127.0.0.1:8000/cars/), менеджер:
![[Pasted image 20220729172557.png]]
- видит общее кол-во (или кол-во отфильтрованных) авто;
![[Pasted image 20220708140121.png]]
- может добавить новое авто. При нажатии на кнопку "добавить авто", открывается форма;
![[Pasted image 20220708140243.png]]
При введении корректных данных и нажатии кнопки "отправить", новое авто появляется в таблице.
При введении некорректных данных, форма возвращается с сообщениями об ошибках.
![[Pasted image 20220708140450.png]]
- фильтровать автомобили по их параметрам;
![[Pasted image 20220708140539.png]]
- удалять и изымать выбранные автомобили.
![[Pasted image 20220708141109.png]]

### Водители
Стр. [водители](http://127.0.0.1:8000/drivers/) аналогична стр. Автомобили, за исключением возможности добавления новых водителей.
![[Pasted image 20220708140801.png]]
### Документы
Стр. [документы](http://127.0.0.1:8000/documents/) отличается от стр. Водители одновременной работой c двумя таблицами: "документы авто" и "документы водителей".
![[Pasted image 20220708141014.png]]
### Топливные карты
стр. [топливные карты](http://127.0.0.1:8000/cards/) идентична стр. Автомобили.
![[Pasted image 20220708141158.png]]
### Заявки
стр. [заявки](http://127.0.0.1:8000/applications) идентична стр. Водители.
![[Pasted image 20220708141237.png]]
### История
стр. [история](127.0.0.1:8000/history/) отображает всю историю действий пользователей. Также есть возможность фильтровать историю по времени, типу и статусу.
![[Pasted image 20220708141456.png]]
### Выбранный водитель
Стр. Выбранного водителя отображает всю информацию о нем и связанных с ним записях.
![[Pasted image 20220708143423.png]]
Также на этой стр. имеется возможность присвоить водителю одну из свободных топливных карт.
![[Pasted image 20220708143459.png]]

### Celery
Для обработки фоновых и переодических задач была использована программа celery и redis в качестве брокера задач.  
Реализованные задачи:

фоновые задачи:

-   отправка кода активации аккаунта на email user'а.

переодические задачи:

-   создание заявки на плановый осмотр авто;
-   создание уведомления об истекающем сроке действия документов;
-   удаление "пустых" топливных карт;
-   создание уведомлений о том, что заканчиваются топливные карты;
-   создание уведомлений о просроченных заявках.

### TelegramBot
Телеграмм бот разработан в качестве дополнения к веб-приложению "CarPark".
Основной функционал:
- Отправка уведомлений пользователям;
- Обработка заявок (механиками).

#### Авторизация
При первом запуске телеграмм бота (вводе команды /start), он просит доступ к номеру телефону. Номер телефона должен совпадать с номером, указанным во время регистрации.
![[Pasted image 20220708155138.png]]
После отправки номера и его успешной валидации, пользователь получает доступ к главному меню.
![[Pasted image 20220708155522.png]]

#### Уведомления
После нажатия кнопки "уведомления", пользователь из основного меню попадает в меню активные уведомления.
![[Pasted image 20220708164124.png]]
Используя "<<" и "">>" можно перемещаться между уведомлениями
![[Pasted image 20220708164226.png]].
Кнопка "подтвердить" делает уведомление просмотренным.
![[Pasted image 20220708164339.png]]

#### Заявки
После нажатия кнопки "Заявки", пользователь из основного меню попадает в меню заявки.
![[Pasted image 20220708174231.png]]

Нажатие кнопки "Новые заявки" генерирует первую заявку, рассмотренную менеджером. Нажатие кнопки "Приступить к ремонту", изменяет статус заявки на "Ремонтируется" и удаляет ее из списка новых заявок!
![[Pasted image 20220708174731.png]]
Нажатие кнопки "Приступить к ремонту", изменяет статус заявки на "Ремонтируется" и удаляет ее из списка новых заявок!
![[Pasted image 20220708174746.png]]

После завершение ремотных работ, механик должен перейти в меню "Активные заявки" и нажать кнопку "Выполнить заявку".
![[Pasted image 20220708175015.png]]

Если кнопка выполнения заявки была нажата по ошибке, есть возможность вернуть заявке статус *ремонтируется*, перейдя в раздел меню "Выполненные заявки" и нажав кнопку "Доработать заявку".

![[Pasted image 20220708175209.png]]
